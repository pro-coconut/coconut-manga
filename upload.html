<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Đăng Truyện - Coconut Manga</title>
<style>
  body{background:#f0f2f5;font-family:Arial;margin:0;padding:10px}
  .box{max-width:600px;margin:10px auto;background:#fff;border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,0.15);overflow:hidden}
  header{background:#e74c3c;color:#fff;text-align:center;padding:25px 10px}
  h1{margin:0;font-size:24px}
  .f{padding:20px}
  input[type=text],input[type=file]{width:100%;padding:12px;margin:10px 0;border:1px solid #ddd;border-radius:8px;box-sizing:border-box}
  .drop{border:3px dashed #e74c3c;background:#fff8f8;padding:40px;text-align:center;border-radius:12px;margin:15px 0;cursor:pointer}
  button{width:100%;padding:15px;background:#e74c3c;color:#fff;border:none;border-radius:10px;font-size:18px;margin-top:10px}
  .p{height:10px;background:#eee;border-radius:5px;margin:15px 0;overflow:hidden}
  .pb{height:100%;width:0;background:#e74c3c;transition:width .4s}
  #s{text-align:center;padding:10px;font-weight:bold}
</style>
</head>
<body>
<div class="box">
  <header><h1>ĐĂNG TRUYỆN</h1></header>
  <div class="f">
    <input type="text" id="title" placeholder="Tên truyện (bắt buộc)" required>
    <input type="text" id="id" placeholder="ID (không dấu, vd: tavodich)" required>
    <input type="text" id="author" placeholder="Tác giả (tuỳ chọn)">
    <input type="file" id="cover" accept="image/*" required>
    <input type="text" id="chap" placeholder="Tên chapter" value="Chapter 1">
    <div class="drop" id="d">Kéo thả ảnh chapter vào đây<br>hoặc nhấn để chọn</div>
    <input type="file" id="imgs" multiple accept="image/*" style="display:none">
    <button onclick="up()">GỬI TRUYỆN</button>
    <div class="p"><div class="pb" id="pb"></div></div>
    <div id="s">Sẵn sàng</div>
  </div>
</div>

<script>
// Token
if (!localStorage.gh_token) {
  let t = prompt("Nhập GitHub Token (ghp_...)");
  if (t && t.startsWith("ghp_")) localStorage.gh_token = t;
  else { alert("Token sai!"); throw ""; }
}
const token = localStorage.gh_token;
const api = "https://api.github.com/repos/pro-coconut/pro-coconut.github.io/contents";

// Upload file (đã fix triệt để vòng lặp)
async function uploadFile(path, file) {
  const b64 = btoa(String.fromCharCode(...new Uint8Array(await file.arrayBuffer())));
  const payload = {
    message: "upload",
    content: b64,
    branch: "main"
  };
  // Chỉ thêm sha nếu file đã tồn tại
  try {
    const r = await fetch(api + "/" + path + "?ref=main", {headers:{Authorization:"token "+token}});
    if (r.ok) {
      const j = await r.json();
      payload.sha = j.sha;
    }
  } catch(e) {}
  const res = await fetch(api + "/" + path, {
    method: "PUT",
    headers: {Authorization:"token "+token, "Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  if (!res.ok) throw "Upload fail";
  return "https://raw.githubusercontent.com/pro-coconut/pro-coconut.github.io/main/" + path;
}

// Lấy + lưu stories.json
async function loadJson() {
  const r = await fetch("https://raw.githubusercontent.com/pro-coconut/pro-coconut.github.io/main/stories.json?t="+Date.now());
  return r.status===404 ? [] : await r.json();
}
async function saveJson(data) {
  const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(data,null,2))));
  const payload = {message:"update stories",content:b64,branch:"main"};
  try {
    const r = await fetch(api+"/stories.json", {headers:{Authorization:"token "+token}});
    if (r.ok) payload.sha = (await r.json()).sha;
  } catch(e) {}
  await fetch(api+"/stories.json", {method:"PUT",headers:{Authorization:"token "+token,"Content-Type":"application/json"},body:JSON.stringify(payload)});
}

// Main
async function up() {
  const s = document.getElementById("s");
  const pb = document.getElementById("pb");
  try {
    s.textContent = "Đang xử lý..."; pb.style.width="10%";
    const id = document.getElementById("id").value.trim().toLowerCase().replace(/[^a-z0-9]/g,"");
    if (!id || !document.getElementById("title").value) throw "Nhập tên + ID";
    if (!document.getElementById("cover").files[0]) throw "Chọn bìa";
    if (!document.getElementById("imgs").files.length) throw "Chọn ảnh chapter";

    // Bìa
    s.textContent = "Upload bìa..."; pb.style.width="25%";
    const cover = await uploadFile("images/"+id+"_cover.jpg", document.getElementById("cover").files[0]);

    // Chapter
    const files = document.getElementById("imgs").files;
    const urls = [];
    for(let i=0;i<files.length;i++){
      s.textContent = "Ảnh "+(i+1)+"/"+files.length;
      urls.push(await uploadFile("images/"+id+"_"+(i+1)+".jpg", files[i]));
      pb.style.width = 25 + 65*(i+1)/files.length + "%";
    }

    // stories.json
    s.textContent = "Cập nhật danh sách..."; pb.style.width="95%";
    const list = await loadJson();
    const ex = list.find(x=>x.id===id);
    const ch = {name: document.getElementById("chap").value || "Chapter mới", images: urls};
    if (ex) ex.chapters.push(ch);
    else list.push({id, title:document.getElementById("title").value, author:document.getElementById("author").value||"Không rõ", thumbnail:cover, chapters:[ch]});
    await saveJson(list);

    pb.style.width="100%";
    s.innerHTML = "HOÀN TẤT! Truyện đã lên sóng<br>Reload trang chủ là thấy ngay!";
  } catch(e) {
    s.innerHTML = "LỖI: "+e;
    pb.style.width="0%";
  }
}

// Drag drop
document.getElementById("d").onclick = ()=>document.getElementById("imgs").click();
document.getElementById("d").ondrop = e=>{e.preventDefault(); document.getElementById("imgs").files=e.dataTransfer.files; document.getElementById("d").innerHTML="Đã chọn "+e.dataTransfer.files.length+" ảnh"};
document.getElementById("d").ondragover = e=>e.preventDefault();
</script>
</body>
</html>
