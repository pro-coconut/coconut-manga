<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêƒÉng Truy·ªán - Coconut Manga</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            margin: 20px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        header {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            text-align: center;
            padding: 30px 20px;
        }
        h1 {
            margin: 0;
            font-size: 2.2em;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .form-group {
            padding: 20px;
        }
        label {
            display: block;
            margin: 15px 0 8px;
            font-weight: bold;
            color: #333;
        }
        input[type="text"], input[type="file"] {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 12px;
            font-size: 16px;
            box-sizing: border-box;
            transition: all 0.3s;
        }
        input:focus {
            outline: none;
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231,76,60,0.2);
        }
        .drop-zone {
            border: 3px dashed #e74c3c;
            background: #fff8f8;
            padding: 50px 20px;
            text-align: center;
            border-radius: 15px;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        .drop-zone:hover {
            background: #ffeaea;
            border-color: #c0392b;
        }
        .drop-zone.dragover {
            background: #ffdddd;
            transform: scale(1.02);
        }
        button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 8px 20px rgba(231,76,60,0.4);
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(231,76,60,0.5);
        }
        button:active {
            transform: translateY(0);
        }
        .progress {
            height: 12px;
            background: #f0f0f0;
            border-radius: 6px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #e74c3c, #ff6b6b);
            transition: width 0.4s ease;
        }
        #status {
            text-align: center;
            padding: 15px;
            font-weight: bold;
            font-size: 1.1em;
            min-height: 50px;
        }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ƒêƒÇNG TRUY·ªÜN M·ªöI</h1>
    </header>

    <div class="form-group">
        <label for="title">T√™n truy·ªán *</label>
        <input type="text" id="title" placeholder="V√≠ d·ª•: Ta V√¥ ƒê·ªãch L√∫c N√†o" required>

        <label for="id">ID truy·ªán (kh√¥ng d·∫•u, vi·∫øt th∆∞·ªùng) *</label>
        <input type="text" id="id" placeholder="V√≠ d·ª•: tavodichlucnao" required>

        <label for="author">T√°c gi·∫£</label>
        <input type="text" id="author" placeholder="Kh√¥ng b·∫Øt bu·ªôc">

        <label for="cover">·∫¢nh b√¨a truy·ªán *</label>
        <input type="file" id="cover" accept="image/*" required>

        <label for="chap">T√™n chapter</label>
        <input type="text" id="chap" value="Chapter 1">

        <label>·∫¢nh c√°c trang chapter *</label>
        <div class="drop-zone" id="dropZone">
            <p>üìÅ K√©o th·∫£ ·∫£nh v√†o ƒë√¢y<br>ho·∫∑c <strong>nh·∫•n ƒë·ªÉ ch·ªçn nhi·ªÅu ·∫£nh</strong></p>
        </div>
        <input type="file" id="chapterImages" multiple accept="image/*" style="display:none">

        <button onclick="uploadStory()">G·ª¨I TRUY·ªÜN NGAY</button>

        <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
        <div id="status">S·∫µn s√†ng ƒëƒÉng truy·ªán ‚ú®</div>
    </div>
</div>

<script>
let TOKEN = localStorage.getItem("gh_token");
if (!TOKEN) {
    TOKEN = prompt("Nh·∫≠p GitHub Personal Access Token (ghp_...)\nCh·ªâ hi·ªán 1 l·∫ßn duy nh·∫•t!");
    if (TOKEN && TOKEN.startsWith("ghp_")) {
        localStorage.setItem("gh_token", TOKEN);
    } else {
        alert("Token kh√¥ng h·ª£p l·ªá!");
        throw new Error("No valid token");
    }
}

const REPO = "pro-coconut/pro-coconut.github.io";
const API_BASE = "https://api.github.com/repos/" + REPO + "/contents";
const RAW_BASE = "https://raw.githubusercontent.com/" + REPO + "/main";

// L·∫•y SHA c·ªßa file (n·∫øu c√≥)
async function getFileSha(path) {
    try {
        const res = await fetch(API_BASE + "/" + path, {
            headers: { Authorization: "token " + TOKEN }
        });
        if (res.ok) {
            const data = await res.json();
            return data.sha;
        }
    } catch (e) {}
    return null;
}

// Upload 1 file ·∫£nh
async function uploadImage(path, file) {
    if (file.size > 10 * 1024 * 1024) throw "·∫¢nh qu√° l·ªõn (>10MB)!";
    
    const arrayBuffer = await file.arrayBuffer();
    const base64 = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));
    const sha = await getFileSha(path);

    const response = await fetch(API_BASE + "/" + path, {
        method: "PUT",
        headers: {
            Authorization: "token " + TOKEN,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            message: "Upload ·∫£nh truy·ªán",
            content: base64,
            branch: "main",
            sha: sha
        })
    });

    if (!response.ok) {
        const err = await response.text();
        throw "Upload th·∫•t b·∫°i: " + err;
    }

    return RAW_BASE + "/" + path;
}

// L·∫•y danh s√°ch truy·ªán hi·ªán t·∫°i
async function getStories() {
    try {
        const res = await fetch(RAW_BASE + "/stories.json?t=" + Date.now());
        if (res.status === 404) return [];
        return await res.json();
    } catch (e) {
        return [];
    }
}

// L∆∞u l·∫°i stories.json
async function saveStories(data) {
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
    const sha = await getFileSha("stories.json");

    await fetch(API_BASE + "/stories.json", {
        method: "PUT",
        headers: {
            Authorization: "token " + TOKEN,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            message: "C·∫≠p nh·∫≠t danh s√°ch truy·ªán",
            content: content,
            branch: "main",
            sha: sha
        })
    });
}

// H√†m ch√≠nh
async function uploadStory() {
    const status = document.getElementById("status");
    const progress = document.getElementById("progressBar");

    try {
        status.textContent = "ƒêang chu·∫©n b·ªã...";
        progress.style.width = "5%";

        const title = document.getElementById("title").value.trim();
        const id = document.getElementById("id").value.trim().toLowerCase().replace(/[^a-z0-9]/g, "");
        const author = document.getElementById("author").value.trim() || "ƒêang c·∫≠p nh·∫≠t";
        const chapName = document.getElementById("chap").value.trim() || "Chapter m·ªõi";
        const coverFile = document.getElementById("cover").files[0];
        const chapterFiles = document.getElementById("chapterImages").files;

        if (!title || !id) throw "H√£y nh·∫≠p t√™n truy·ªán v√† ID!";
        if (!coverFile) throw "Ch·ªçn ·∫£nh b√¨a!";
        if (chapterFiles.length === 0) throw "Ch·ªçn √≠t nh·∫•t 1 ·∫£nh chapter!";

        status.textContent = "ƒêang upload ·∫£nh b√¨a...";
        progress.style.width = "20%";
        const coverUrl = await uploadImage(`images/${id}_cover.jpg`, coverFile);

        status.textContent = "ƒêang upload c√°c trang...";
        const imageUrls = [];
        for (let i = 0; i < chapterFiles.length; i++) {
            status.textContent = `ƒêang upload trang ${i + 1}/${chapterFiles.length}...`;
            progress.style.width = `${25 + (i + 1) / chapterFiles.length * 65}%`;
            const url = await uploadImage(`images/${id}_chap_${i + 1}.jpg`, chapterFiles[i]);
            imageUrls.push(url);
        }

        status.textContent = "ƒêang c·∫≠p nh·∫≠t danh s√°ch truy·ªán...";
        progress.style.width = "95%";

        const stories = await getStories();
        const existing = stories.find(s => s.id === id);
        const newChapter = { name: chapName, images: imageUrls };

        if (existing) {
            existing.chapters.push(newChapter);
        } else {
            stories.push({
                id: id,
                title: title,
                author: author,
                thumbnail: coverUrl,
                chapters: [newChapter]
            });
        }

        await saveStories(stories);

        progress.style.width = "100%";
        status.innerHTML = `<span class="success">HO√ÄN T·∫§T 100%!<br>Truy·ªán ƒë√£ ƒë∆∞·ª£c ƒëƒÉng th√†nh c√¥ng üéâ<br>Reload trang ch·ªß l√† th·∫•y ngay!</span>`;

    } catch (error) {
        status.innerHTML = `<span class="error">L·ªñI: ${error}</span>`;
        progress.style.width = "0%";
    }
}

// Drag & drop
const dropZone = document.getElementById("dropZone");
dropZone.onclick = () => document.getElementById("chapterImages").click();
dropZone.ondragover = e => { e.preventDefault(); dropZone.classList.add("dragover"); };
dropZone.ondragleave = () => dropZone.classList.remove("dragover");
dropZone.ondrop = e => {
    e.preventDefault();
    dropZone.classList.remove("dragover");
    document.getElementById("chapterImages").files = e.dataTransfer.files;
    dropZone.innerHTML = `<strong>ƒê√£ ch·ªçn ${e.dataTransfer.files.length} ·∫£nh</strong><br>S·∫µn s√†ng ƒëƒÉng!`;
};
</script>

</body>
</html>
