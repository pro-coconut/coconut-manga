<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Upload Truyện</title>
<style>
body { font-family: Arial; padding: 20px; }
input, textarea { width: 100%; margin: 6px 0; padding: 8px; }
button { padding: 10px 15px; cursor: pointer; }
</style>
</head>
<body>

<h2>Đăng truyện</h2>

<label>Tên truyện</label>
<input id="storyName">

<label>Mô tả</label>
<textarea id="description"></textarea>

<label>Link bìa</label>
<input id="coverUrl">

<label>ID truyện (nếu cập nhật chap)</label>
<input id="storyId">

<label>Link ảnh chapter (mỗi dòng 1 link)</label>
<textarea id="chapterImages"></textarea>

<button onclick="startUpload()">Đăng truyện</button>

<script>
// Hỏi token khi người dùng bấm đăng truyện
async function askToken() {
    let token = sessionStorage.getItem("github_token");

    if (!token) {
        token = prompt("Nhập GitHub Token để upload:");
        if (!token) {
            alert("Bạn phải nhập token mới tiếp tục được.");
            return null;
        }
        sessionStorage.setItem("github_token", token);
    }
    return token;
}

async function startUpload() {
    const token = await askToken();
    if (!token) return;

    uploadStory(token);
}

// Hàm upload chính
async function uploadStory(token) {
    const repoOwner = "YOUR_USERNAME";
    const repoName = "YOUR_REPO";
    const branch = "main";

    const storyName = document.getElementById("storyName").value.trim();
    const description = document.getElementById("description").value.trim();
    const coverUrl = document.getElementById("coverUrl").value.trim();
    const storyId = document.getElementById("storyId").value.trim();
    const chapterImages = document.getElementById("chapterImages").value.trim().split("\n");

    if (!storyName) return alert("Tên truyện không được để trống!");

    const apiBase = `https://api.github.com/repos/${repoOwner}/${repoName}/contents`;

    // Lấy file stories.json
    const storiesRes = await fetch(`${apiBase}/stories.json?ref=${branch}`);
    if (!storiesRes.ok) return alert("Không tải được stories.json");

    const storiesData = await storiesRes.json();
    const stories = JSON.parse(atob(storiesData.content));

    let sid = storyId;
    if (!sid) {
        sid = Date.now().toString();
        stories[sid] = {
            name: storyName,
            description,
            cover: coverUrl,
            chapters: []
        };
    }

    // Tạo chương mới
    const chapterIndex = stories[sid].chapters.length + 1;
    const chapterPath = `chapters/${sid}/${chapterIndex}.json`;

    const chapterData = {
        id: chapterIndex,
        images: chapterImages
    };

    // Upload chapter
    await fetch(`${apiBase}/${chapterPath}`, {
        method: "PUT",
        headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            message: `Add chapter ${chapterIndex}`,
            content: btoa(JSON.stringify(chapterData, null, 2)),
            branch
        })
    });

    // Cập nhật danh sách chương
    stories[sid].chapters.push({
        id: chapterIndex,
        file: chapterPath
    });

    // Upload stories.json
    await fetch(`${apiBase}/stories.json`, {
        method: "PUT",
        headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            message: "Update stories list",
            content: btoa(JSON.stringify(stories, null, 2)),
            sha: storiesData.sha,
            branch
        })
    });

    alert("Đăng truyện thành công!");
}
</script>

</body>
</html>
