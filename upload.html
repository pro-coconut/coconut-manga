<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Đăng Truyện - Coconut Manga</title>
<style>
body{font-family:Arial,sans-serif;background:#f4f4f9;margin:0;padding:15px}
.box{max-width:600px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 5px 25px rgba(0,0,0,0.15);overflow:hidden}
h1{background:#e74c3c;color:#fff;text-align:center;padding:20px;margin:0;font-size:24px}
.form{padding:20px}
input[type=text],input[type=file],textarea{width:100%;padding:12px;margin:10px 0;border:1px solid #ddd;border-radius:8px;box-sizing:border-box;font-size:16px}
textarea{height:100px;resize:vertical}
label{font-weight:bold;margin-top:10px;display:block;color:#e74c3c}
button{width:100%;padding:15px;background:#e74c3c;color:#fff;border:none;border-radius:10px;font-size:18px;margin-top:10px;cursor:pointer;transition:0.3s;font-weight:bold}
button:hover{background:#c0392b}
.progress{height:12px;background:#eee;border-radius:6px;overflow:hidden;margin:15px 0}
.bar{height:100%;width:0;background:#e74c3c;transition:width .4s}
#status{text-align:center;padding:10px;font-weight:bold;font-size:16px}
</style>
</head>
<body>

<div class="box">
<h1>ĐĂNG TRUYỆN MỚI</h1>
<div class="form">

<label>ID truyện (bắt buộc, nếu đã có truyện sẽ thêm chapter mới):</label>
<input type="text" id="id" placeholder="vd: tavodich" required>

<label>Tên truyện (bắt buộc nếu truyện mới):</label>
<input type="text" id="title" placeholder="Tên truyện">

<label>Tác giả:</label>
<input type="text" id="author" placeholder="Tác giả (không bắt buộc)">

<label>Tóm tắt truyện (nếu truyện mới):</label>
<textarea id="description" placeholder="Tóm tắt truyện"></textarea>

<hr>

<label>Tên chapter:</label>
<input type="text" id="chap" placeholder="vd: Chapter 1" value="Chapter 1">

<label>Ảnh bìa (file hoặc URL):</label>
<input type="file" id="coverFile" accept="image/*">
<input type="text" id="coverUrl" placeholder="Hoặc nhập URL ảnh bìa">

<label>Ảnh chapter (file hoặc URL, mỗi URL 1 dòng):</label>
<div class="drop" id="dropZone">Kéo thả ảnh chapter vào đây hoặc nhấn để chọn nhiều ảnh</div>
<input type="file" id="chapterFiles" multiple accept="image/*" style="display:none">
<textarea id="chapterUrls" placeholder="Hoặc nhập URL ảnh mỗi dòng"></textarea>

<button onclick="uploadAll()">GỬI TRUYỆN NGAY</button>
<div class="progress"><div class="bar" id="progressBar"></div></div>
<div id="status">Sẵn sàng đăng truyện</div>

</div>
</div>

<script>
// Token GitHub
let token = localStorage.getItem("gh_token");
if(!token||!token.startsWith("ghp_")){
  token = prompt("Nhập GitHub Token (ghp_...) – chỉ hiện 1 lần:");
  if(token && token.startsWith("ghp_")) localStorage.setItem("gh_token", token);
  else { alert("Token sai!"); throw new Error("No token"); }
}

const API = "https://api.github.com/repos/pro-coconut/pro-coconut.github.io/contents";
const RAW = "https://raw.githubusercontent.com/pro-coconut/pro-coconut.github.io/main";

// Drag & drop chapter files
const dropZone = document.getElementById("dropZone");
dropZone.addEventListener("click", ()=>document.getElementById("chapterFiles").click());
dropZone.addEventListener("dragover", e=>e.preventDefault());
dropZone.addEventListener("drop", e=>{
  e.preventDefault();
  const files = e.dataTransfer.files;
  document.getElementById("chapterFiles").files = files;
  dropZone.innerHTML = `<b>Đã chọn ${files.length} ảnh chapter</b><br>Sẵn sàng đăng!`;
});
document.getElementById("chapterFiles").addEventListener("change", ()=>{
  const files = document.getElementById("chapterFiles").files;
  dropZone.innerHTML = `<b>Đã chọn ${files.length} ảnh chapter</b><br>Sẵn sàng đăng!`;
});

// Upload file lên GitHub
async function uploadFile(path, fileOrUrl){
  if(typeof fileOrUrl==="string" && fileOrUrl.startsWith("http")) return fileOrUrl;

  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = async ()=>{
      const base64 = reader.result.split(',')[1];
      const payload = {message:"upload truyện", content:base64, branch:"main"};
      try{
        const res = await fetch(API+"/"+path,{headers:{Authorization:"token "+token}});
        if(res.ok) payload.sha = (await res.json()).sha;
      }catch(e){}
      const putRes = await fetch(API+"/"+path,{
        method:"PUT",
        headers:{Authorization:"token "+token,"Content-Type":"application/json"},
        body:JSON.stringify(payload)
      });
      if(putRes.ok) resolve(RAW+"/"+path);
      else reject("Upload thất bại: "+path);
    };
    reader.onerror = ()=>reject("Lỗi đọc file: "+fileOrUrl.name);
    reader.readAsDataURL(fileOrUrl);
  });
}

// Hàm chính
async function uploadAll(){
  const status = document.getElementById("status");
  const bar = document.getElementById("progressBar");
  try{
    status.textContent = "Đang chuẩn bị...";
    bar.style.width="5%";

    const id = document.getElementById("id").value.trim().toLowerCase().replace(/[^a-z0-9]/g,"");
    const title = document.getElementById("title").value.trim();
    const chapName = document.getElementById("chap").value.trim() || "Chapter mới";
    if(!id) throw "Nhập ID truyện!";

    // Xử lý cover
    let coverUrl = document.getElementById("coverUrl").value.trim();
    const coverFile = document.getElementById("coverFile").files[0];
    if(!coverUrl && coverFile) coverUrl = await uploadFile(`images/${id}_cover.jpg`, coverFile);
    if(!coverUrl && !coverFile && !title) throw "Chưa nhập bìa hoặc tên truyện mới!";

    // Xử lý chapter
    const chapterUrls = document.getElementById("chapterUrls").value.trim().split("\n").filter(l=>l);
    const chapterFiles = document.getElementById("chapterFiles").files;
    const images = [...chapterUrls];
    for(let i=0;i<chapterFiles.length;i++){
      const url = await uploadFile(`images/${id}_p${i+1}.jpg`, chapterFiles[i]);
      images.push(url);
      bar.style.width=`${20 + (i+1)/chapterFiles.length*70}%`;
    }

    // Cập nhật stories.json
    status.textContent="Cập nhật danh sách...";
    bar.style.width="95%";
    const stories = await fetch(RAW+"/stories.json?t="+Date.now()).then(r=>r.ok?r.json():[]);
    let exist = stories.find(s=>s.id===id);
    const newChap = {name: chapName, images};

    if(exist){
      exist.chapters.push(newChap);
      if(document.getElementById("description").value) exist.description=document.getElementById("description").value;
    }else{
      stories.push({
        id, title, author: document.getElementById("author").value||"Không rõ",
        description: document.getElementById("description").value||"Chưa có tóm tắt",
        thumbnail: coverUrl,
        chapters: [newChap]
      });
    }

    const jsonBlob = new Blob([JSON.stringify(stories,null,2)],{type:"application/json"});
    await uploadFile("stories.json", jsonBlob);

    bar.style.width="100%";
    status.innerHTML="<b style='color:green'>HOÀN TẤT 100%!<br>Reload trang chủ để xem!</b>";

  }catch(e){
    status.innerHTML="<b style='color:red'>LỖI: "+e+"</b>";
    bar.style.width="0%";
  }
}
</script>

</body>
</html>
