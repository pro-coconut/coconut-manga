<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Đăng Truyện - Coconut Manga</title>
<style>
  body{background:#f4f4f9;font-family:Arial;margin:0;padding:15px}
  .box{max-width:560px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 5px 25px rgba(0,0,0,0.15);overflow:hidden}
  h1{background:#e74c3c;color:#fff;text-align:center;padding:20px;margin:0}
  .form{padding:20px}
  input,button{width:100%;padding:12px;margin:10px 0;border-radius:8px;border:1px solid #ddd;box-sizing:border-box}
  button{background:#e74c3c;color:#fff;border:none;font-size:18px;cursor:pointer}
  .drop{border:3px dashed #e74c3c;padding:40px;text-align:center;border-radius:12px;cursor:pointer}
  .bar{height:12px;background:#eee;border-radius:6px;overflow:hidden;margin:15px 0}
  .fill{height:100%;width:0;background:#e74c3c;transition:width .4s}
  #status{text-align:center;font-weight:bold;padding:10px}
</style>
</head>
<body>
<div class="box">
  <h1>ĐĂNG TRUYỆN MỚI</h1>
  <div class="form">
    <input type="text" id="title" placeholder="Tên truyện" required>
    <input type="text" id="id" placeholder="ID (không dấu)" required>
    <input type="text" id="author" placeholder="Tác giả (tuỳ chọn)">
    <input type="file" id="cover" accept="image/*" required>
    <input type="text" id="chap" placeholder="Tên chapter" value="Chapter 1">
    <div class="drop" id="drop">Kéo thả ảnh chapter vào đây hoặc nhấn chọn</div>
    <input type="file" id="imgs" multiple accept="image/*" style="display:none">
    <button onclick="start()">GỬI NGAY</button>
    <div class="bar"><div class="fill" id="fill"></div></div>
    <div id="status">Sẵn sàng</div>
  </div>
</div>

<script>
let token = localStorage.getItem("t") || prompt("Nhập token GitHub (ghp_...)");
if(token && token.startsWith("ghp_")) localStorage.setItem("t", token);
else { alert("Token sai"); throw""; }

const repo = "pro-coconut/pro-coconut.github.io";
const api = "https://api.github.com/repos/"+repo+"/contents";

async function up(path, content) {
  const payload = {message:"upload", content, branch:"main"};
  try {
    const r = await fetch(api+"/"+path,{headers:{Authorization:"token "+token}});
    if(r.ok) payload.sha = (await r.json()).sha;
  }catch(e){}
  const res = await fetch(api+"/"+path, {
    method:"PUT",
    headers:{Authorization:"token "+token,"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });
  if(!res.ok) throw "Lỗi upload";
  return "https://raw.githubusercontent.com/"+repo+"/main/"+path;
}

document.getElementById("drop").onclick = () => document.getElementById("imgs").click();
document.getElementById("drop").ondrop = e => {e.preventDefault(); document.getElementById("imgs").files = e.dataTransfer.files; updateCount();};
document.getElementById("imgs").onchange = updateCount;
function updateCount() {
  const c = document.getElementById("imgs").files.length;
  document.getElementById("drop").innerHTML = c ? "Đã chọn <b>"+c+"</b> ảnh" : "Kéo thả ảnh chapter vào đây";
}

async function start() {
  const s = document.getElementById("status");
  const f = document.getElementById("fill");
  try {
    s.textContent = "Bắt đầu..."; f.style.width = "5%";
    const id = document.getElementById("id").value.trim().toLowerCase().replace(/[^a-z0-9]/g,"");
    if(!id || !document.getElementById("title").value) throw "Nhập tên + ID";

    // Upload bìa
    const coverFile = document.getElementById("cover").files[0];
    const coverData = await new Promise(r => {let fr=new FileReader();fr.onload=e=>r(e.target.result.split(',')[1]);fr.readAsDataURL(coverFile);});
    s.textContent = "Upload bìa..."; f.style.width = "20%";
    const coverUrl = await up("images/"+id+"_cover.jpg", coverData);

    // Upload chapter
    const files = document.getElementById("imgs").files;
    const urls = [];
    for(let i=0; i<files.length; i++){
      s.textContent = "Upload "+(i+1)+"/"+files.length;
      const data = await new Promise(r => {let fr=new FileReader();fr.onload=e=>r(e.target.result.split(',')[1]);fr.readAsDataURL(files[i]);});
      urls.push(await up("images/"+id+"_"+(i+1)+".jpg", data));
      f.style.width = (20 + 75*(i+1)/files.length)+"%";
    }

    // stories.json
    s.textContent = "Cập nhật danh sách..."; f.style.width = "95%";
    const stories = await fetch("https://raw.githubusercontent.com/"+repo+"/main/stories.json?t="+Date.now()).then(r=>r.ok?r.json():[]);
    const exist = stories.find(x=>x.id===id);
    const chap = {name:document.getElementById("chap").value, images:urls};
    if(exist) exist.chapters.push(chap);
    else stories.push({id,title:document.getElementById("title").value,author:document.getElementById("author").value||"Không rõ",thumbnail:coverUrl,chapters:[chap]});
    const json64 = btoa(unescape(encodeURIComponent(JSON.stringify(stories,null,2))));
    await up("stories.json", json64);

    f.style.width = "100%";
    s.innerHTML = "<b style='color:green'>HOÀN TẤT 100%!<br>Reload trang chủ là thấy truyện!</b>";
  } catch(e) {
    s.innerHTML = "<b style='color:red'>LỖI: "+e+"</b>";
    f.style.width = "0%";
  }
}
</script>
</body>
</html>
